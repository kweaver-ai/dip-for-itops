apiVersion: apps/v1
kind: Deployment
metadata:
  name: "{{.Values.dipModule}}"
  namespace: {{.Values.namespace}}
  labels:
    anyrobot-module: "{{.Values.dipModule}}"
    {{.Values.dipModule}}-{{.Values.cluster}}-service: "true"
    cluster: {{.Values.cluster}}
spec:
  replicas: {{.Values.replicaCount}}
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 2
      maxUnavailable: 1
  selector:
    matchLabels:
      anyrobot-module: {{.Values.dipModule}}
      {{.Values.dipModule}}-{{.Values.cluster}}-service: "true"
      cluster: {{.Values.cluster}}
  template:
    metadata:
      labels:
        anyrobot-module: {{.Values.dipModule}}
        {{.Values.dipModule}}-{{.Values.cluster}}-service: "true"
        cluster: {{.Values.cluster}}
    spec:
      {{- with .Values.securityContext }}
      securityContext:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- if .Values.antiAffinity.enabled }}
      affinity:
        {{- if eq .Values.antiAffinity.rule "soft" }}
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                topologyKey: kubernetes.io/hostname
                labelSelector:
                  matchExpressions:
                    - key: anyrobot-module
                      operator: In
                      values:
                        - {{.Values.dipModule}}
        {{- else if eq .Values.antiAffinity.rule "hard" }}
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - topologyKey: kubernetes.io/hostname
              labelSelector:
                matchExpressions:
                  - key: anyrobot-module
                    operator: In
                    values:
                      - {{.Values.dipModule}}
        {{- end }}
      {{- end }}
      containers:
      - name: "{{.Values.dipModule}}"
        image: {{.Values.image.registry}}{{.Values.image.repository}}:{{.Values.image.tag}}
        imagePullPolicy: {{.Values.image.pullPolicy}}
        #command: ["/bin/sh"]
        #args: ["-c","while true; do echo 123; sleep 10; done"]
        env:
          {{- if .Values.env.timezone}}
          - name: TZ
            value: {{ .Values.env.timezone }}
          {{- end}}
          {{- if .Values.env.language}}
          - name: LANG
            value: {{ .Values.env.language }}
          {{- end}}
        ports:
          - name: http
            containerPort: {{ .Values.service.port }}
            protocol: TCP
        {{- if .Values.service.livenessProbe}}
        livenessProbe:
          tcpSocket:
            port: {{.Values.service.port}}
          {{- toYaml .Values.service.livenessProbe | nindent 10 }}
        {{- end}}
        {{- if .Values.service.readinessProbe}}
        readinessProbe:
          tcpSocket:
            port: {{.Values.service.port}}
          {{- toYaml .Values.service.readinessProbe | nindent 10 }}
        {{- end}}
        {{- if .Values.resources}}
        resources:
          {{- toYaml .Values.resources | nindent 10 }}
        {{- end}}
        volumeMounts:
        - mountPath: /etc/localtime
          name: local-time
        - mountPath: /anyrobot/logs/{{.Values.dipModule}}
          name: {{.Values.dipModule}}-log
      volumes:
      - name: local-time
        hostPath:
          path: /etc/localtime
          type: File
      - name: {{.Values.dipModule}}-log
        hostPath:
          path: /anyrobot/logs/{{.Values.dipModule}}
          type: DirectoryOrCreate
      restartPolicy: Always
      dnsConfig:
        options:
          - name: single-request-reopen
          - name: use-vc
